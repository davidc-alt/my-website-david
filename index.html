<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Type Interactive Model By David B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles - kept relatively simple */
        .draggable {
            touch-action: none; /* Prevent scrolling on touch devices during drag */
            cursor: grab;
            user-select: none; /* Prevent text selection during drag */
        }
        .dragging {
            opacity: 0.5;
            cursor: grabbing;
            /* Ensure dragging item is above others */
            z-index: 1000;
            position: relative; /* Needed for z-index */
        }
        .drop-zone {
            border: 2px dashed #ccc;
            transition: background-color 0.3s ease;
            min-height: 50px; /* Ensure drop zones have some height */
            position: relative; /* For positioning elements inside */
        }
        .drop-zone-hover {
            background-color: #e0f2fe; /* Light blue on hover */
        }
        .correct-drop {
            background-color: #dcfce7 !important; /* Light green */
            border-color: #22c55e !important; /* Green */
        }
        .incorrect-drop {
            background-color: #fee2e2 !important; /* Light red */
            border-color: #ef4444 !important; /* Red */
        }
        /* Blood Typing Simulation Styles */
        .serum-well {
            width: 3rem; /* 48px */
            height: 3rem; /* 48px */
            border-radius: 50%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 0.25rem;
            border: 1px solid #9ca3af; /* gray-400 */
            transition: background-color 0.3s, background-image 0.3s;
        }
        .clumped {
            background-color: #fecaca; /* red-200 */
            /* Simple dot pattern for clumping */
            background-image: radial-gradient(#ef4444 15%, transparent 16%),
                              radial-gradient(#ef4444 15%, transparent 16%);
            background-size: 8px 8px;
            background-position: 0 0, 4px 4px;
            border: 1px solid #dc2626; /* red-600 */
        }
        .not-clumped {
            background-color: #fda4af; /* rose-300 */
            border: 1px solid #f43f5e; /* rose-500 */
        }
         /* Styling for Hemostasis steps */
        .step {
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            text-align: center;
            font-size: 0.875rem; /* text-sm */
        }
        .step-source .step {
            background-color: #e0e7ff; /* indigo-100 */
            border: 1px solid #a5b4fc; /* indigo-300 */
            cursor: grab;
        }
        .step-target .step {
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #d1d5db; /* gray-300 */
            cursor: default; /* Steps in target are not grabbable */
        }
        .step-target.correct-sequence .step {
             background-color: #dcfce7; /* green-100 */
             border: 1px solid #86efac; /* green-300 */
        }
        /* Ensure hidden pages don't affect layout */
        .page.hidden {
            display: none;
        }
        .page.active-page {
            display: block;
        }
        /* Style for blood bags */
        .blood-bag {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 1px solid #f87171; /* red-400 */
            background-color: #fca5a5; /* red-300 */
            color: #7f1d1d; /* red-900 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: bold;
            text-align: center;
            cursor: grab;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Style for components dropped in plasma */
        .dropped-component {
            position: absolute; /* Position within the relative drop zone */
            cursor: pointer; /* Allow clicking for info */
        }

    </style>
</head>
<body class="font-[Inter,sans-serif] bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-red-600 text-white p-6 rounded-lg shadow-md mb-8">
            <h1 class="text-3xl md:text-4xl font-bold">Blood Type Interactive Model By David B</h1>
            <p class="mt-2 text-lg">Your interactive guide to the world of blood!</p>
        </header>

        <nav class="mb-8 bg-white p-4 rounded-lg shadow-sm">
            <ul class="flex flex-wrap gap-2 justify-center">
                <li><button data-page="home" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 active">Home</button></li>
                <li><button data-page="components" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Components</button></li>
                <li><button data-page="types" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Blood Types</button></li>
                <li><button data-page="inheritance" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Inheritance</button></li>
                <li><button data-page="transfusions" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Transfusions</button></li>
                <li><button data-page="hemostasis" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Hemostasis</button></li>
                <li><button data-page="quiz" class="nav-button bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Quiz</button></li>
            </ul>
        </nav>

        <main id="page-content" class="bg-white p-6 rounded-lg shadow-md min-h-[400px]">

            <div id="home" class="page active-page">
                <h2 class="text-2xl font-semibold mb-4 text-red-700">Welcome!</h2>
                <p class="mb-4">welcome to this website about blood basics, in witch ill do my best to teach you about soothing I learned about 2 hrs ago! I hope most of this is correct, but at this point im on so much caffeine, and its 3 am, so yea :.3.</p>
                <p class="mb-4">There is no prior knowledge needed, everything you should need should be on here(I hope)</p>
                <p>Use the buttons above to navigate through the different topics.</p>
                <div class="mt-6 text-center">
                    <svg class="inline-block w-24 h-24 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                    <p class="mt-2 font-semibold">Blood is essential for life!</p>
                </div>
            </div>

            <div id="components" class="page hidden">
                <h2 class="text-2xl font-semibold mb-4 text-red-700">What's in Blood? - The Components</h2>
                <p class="mb-4">Blood might look like just red liquid, but it's actually a complex mixture.</p>
                <p class="mb-2">The liquid part is called <strong>Plasma</strong>. It's mostly water, but carries nutrients, hormones, and proteins.</p>
                <p class="mb-4">Floating in the plasma are different types of cells and fragments:</p>
                <ul class="list-disc list-inside mb-4 space-y-2">
                    <li><strong>Red Blood Cells (RBCs):</strong> Carry oxygen. Most numerous.</li>
                    <li><strong>White Blood Cells (WBCs):</strong> Fight infections. Body's defense force.</li>
                    <li><strong>Platelets:</strong> Tiny fragments that help blood clot.</li>
                </ul>

                <h3 class="text-xl font-semibold mb-2">Activity: Build-A-Blood-Drop</h3>
                <p class="mb-4 text-sm text-gray-600">Drag components into the Plasma pool below. You can add multiple copies. Click a component in the pool to learn its function. <button onclick="resetPlasmaPool()" class="text-xs bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded ml-2">Reset Pool</button></p>
                <div class="flex flex-col md:flex-row gap-4 items-start">
                    <div class="flex flex-row md:flex-col gap-2 mb-4 md:mb-0 p-4 border border-gray-300 rounded-lg bg-gray-50">
                        <p class="font-semibold mb-2 text-center md:text-left">Drag These:</p>
                        <div id="drag-rbc" draggable="true" class="draggable p-2 bg-red-400 text-white rounded shadow cursor-grab text-center" data-type="rbc" data-info="Red Blood Cell: Carries Oxygen.">RBC</div>
                        <div id="drag-wbc" draggable="true" class="draggable p-2 bg-blue-400 text-white rounded shadow cursor-grab text-center" data-type="wbc" data-info="White Blood Cell: Fights infection. Part of the immune system.">WBC</div>
                        <div id="drag-platelet" draggable="true" class="draggable p-2 bg-yellow-400 text-gray-800 rounded shadow cursor-grab text-center" data-type="platelet" data-info="Platelet: Small fragment that helps blood clot.">Platelet</div>
                    </div>
                    <div id="plasma-pool" class="drop-zone flex-grow min-h-[200px] p-4 bg-yellow-100 rounded-lg border-2 border-dashed border-yellow-400 relative">
                        <p class="absolute top-2 left-2 text-yellow-700 font-semibold">Plasma Pool</p>
                        </div>
                    <div id="component-info" class="w-full md:w-1/3 p-4 border border-gray-300 rounded-lg bg-gray-50 min-h-[100px]">
                        <p class="font-semibold mb-2">Component Info:</p>
                        <p id="info-text" class="text-gray-700">Click on a component in the pool to see its info here.</p>
                    </div>
                </div>
            </div>

             <div id="types" class="page hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-red-700">Blood Types - ABO & Rh</h2>
                 <p class="mb-4">Your blood type is like an ID tag for your red blood cells, determined by markers called <strong>Antigens</strong>.</p>
                 <h3 class="text-xl font-semibold mb-2">ABO System</h3>
                 <ul class="list-disc list-inside mb-2 space-y-1">
                     <li>Type A: Has A antigens, Anti-B antibodies.</li>
                     <li>Type B: Has B antigens, Anti-A antibodies.</li>
                     <li>Type AB: Has BOTH A and B antigens, NO ABO antibodies.</li>
                     <li>Type O: Has NEITHER A nor B antigens, BOTH Anti-A and Anti-B antibodies.</li>
                 </ul>
                 <h3 class="text-xl font-semibold mb-2">Rh System</h3>
                 <ul class="list-disc list-inside mb-4 space-y-1">
                     <li>Rh Positive (+): Has the Rh antigen.</li>
                     <li>Rh Negative (-): Does NOT have the Rh antigen. Can develop Anti-Rh antibodies if exposed to Rh+ blood.</li>
                 </ul>
                 <h3 class="text-xl font-semibold mb-2">What is Agglutination?</h3>
                 <p class="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                     <strong>Agglutination</strong> means 'clumping together'. This happens when antibodies in plasma encounter the specific antigens they target on red blood cells (e.g., Anti-A antibodies + Type A RBCs = Clumping). This is dangerous inside the body as it blocks blood flow.
                 </p>

                 <h3 class="text-xl font-semibold mb-2">Activity: Virtual Blood Typing Lab</h3>
                 <p class="mb-4 text-sm text-gray-600">Add virtual 'Anti-A', 'Anti-B', and 'Anti-Rh' serums to each sample. Observe if <strong>agglutination</strong> (clumping) occurs. Determine the blood type using the results and the chart. <button onclick="resetTypingLab()" class="text-xs bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded ml-2">Reset Lab</button></p>

                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                     <div class="border p-4 rounded-lg shadow-sm bg-gray-50">
                         <h4 class="font-semibold mb-3 text-center">Sample 1 (<span class="sample-type" data-actual-type="A+">???</span>)</h4>
                         <div class="flex justify-around mb-3">
                             <div class="text-center">
                                 <div id="s1-anti-a" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s1', 'anti-a')" class="text-xs bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded">Anti-A</button>
                             </div>
                             <div class="text-center">
                                 <div id="s1-anti-b" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s1', 'anti-b')" class="text-xs bg-yellow-500 hover:bg-yellow-700 text-white px-2 py-1 rounded">Anti-B</button>
                             </div>
                             <div class="text-center">
                                 <div id="s1-anti-rh" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s1', 'anti-rh')" class="text-xs bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded">Anti-Rh</button>
                             </div>
                         </div>
                         <div class="text-center">
                             <label for="s1-guess" class="mr-2 text-sm">Guess:</label>
                             <select id="s1-guess" class="border rounded p-1 text-sm">
                                 <option value="">Select</option>
                                 <option value="A+">A+</option> <option value="A-">A-</option>
                                 <option value="B+">B+</option> <option value="B-">B-</option>
                                 <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                 <option value="O+">O+</option> <option value="O-">O-</option>
                             </select>
                             <button onclick="checkType('s1')" class="bg-gray-500 hover:bg-gray-700 text-white px-2 py-1 rounded ml-2 text-sm">Check</button>
                         </div>
                         <p id="s1-feedback" class="text-center mt-2 text-sm font-semibold h-4">&nbsp;</p>
                     </div>
                     <div class="border p-4 rounded-lg shadow-sm bg-gray-50">
                          <h4 class="font-semibold mb-3 text-center">Sample 2 (<span class="sample-type" data-actual-type="O-">???</span>)</h4>
                         <div class="flex justify-around mb-3">
                             <div class="text-center">
                                 <div id="s2-anti-a" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s2', 'anti-a')" class="text-xs bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded">Anti-A</button>
                             </div>
                             <div class="text-center">
                                 <div id="s2-anti-b" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s2', 'anti-b')" class="text-xs bg-yellow-500 hover:bg-yellow-700 text-white px-2 py-1 rounded">Anti-B</button>
                             </div>
                             <div class="text-center">
                                 <div id="s2-anti-rh" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s2', 'anti-rh')" class="text-xs bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded">Anti-Rh</button>
                             </div>
                         </div>
                         <div class="text-center">
                             <label for="s2-guess" class="mr-2 text-sm">Guess:</label>
                             <select id="s2-guess" class="border rounded p-1 text-sm">
                                 <option value="">Select</option>
                                  <option value="A+">A+</option> <option value="A-">A-</option>
                                 <option value="B+">B+</option> <option value="B-">B-</option>
                                 <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                 <option value="O+">O+</option> <option value="O-">O-</option>
                             </select>
                             <button onclick="checkType('s2')" class="bg-gray-500 hover:bg-gray-700 text-white px-2 py-1 rounded ml-2 text-sm">Check</button>
                         </div>
                         <p id="s2-feedback" class="text-center mt-2 text-sm font-semibold h-4">&nbsp;</p>
                     </div>
                     <div class="border p-4 rounded-lg shadow-sm bg-gray-50">
                          <h4 class="font-semibold mb-3 text-center">Sample 3 (<span class="sample-type" data-actual-type="AB+">???</span>)</h4>
                         <div class="flex justify-around mb-3">
                             <div class="text-center">
                                 <div id="s3-anti-a" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s3', 'anti-a')" class="text-xs bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded">Anti-A</button>
                             </div>
                             <div class="text-center">
                                 <div id="s3-anti-b" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s3', 'anti-b')" class="text-xs bg-yellow-500 hover:bg-yellow-700 text-white px-2 py-1 rounded">Anti-B</button>
                             </div>
                             <div class="text-center">
                                 <div id="s3-anti-rh" class="serum-well not-clumped"></div>
                                 <button onclick="addSerum('s3', 'anti-rh')" class="text-xs bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded">Anti-Rh</button>
                             </div>
                         </div>
                         <div class="text-center">
                             <label for="s3-guess" class="mr-2 text-sm">Guess:</label>
                             <select id="s3-guess" class="border rounded p-1 text-sm">
                                 <option value="">Select</option>
                                  <option value="A+">A+</option> <option value="A-">A-</option>
                                 <option value="B+">B+</option> <option value="B-">B-</option>
                                 <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                 <option value="O+">O+</option> <option value="O-">O-</option>
                             </select>
                             <button onclick="checkType('s3')" class="bg-gray-500 hover:bg-gray-700 text-white px-2 py-1 rounded ml-2 text-sm">Check</button>
                         </div>
                         <p id="s3-feedback" class="text-center mt-2 text-sm font-semibold h-4">&nbsp;</p>
                     </div>
                 </div>

                 <h4 class="text-lg font-semibold mb-2">Reference Chart:</h4>
                 <div class="overflow-x-auto">
                     <table class="w-full border-collapse border border-gray-300 text-left text-sm mb-4">
                         <thead>
                             <tr class="bg-red-200">
                                 <th class="border border-gray-300 p-2">Clumps w/ Anti-A?</th>
                                 <th class="border border-gray-300 p-2">Clumps w/ Anti-B?</th>
                                 <th class="border border-gray-300 p-2">Clumps w/ Anti-Rh?</th>
                                 <th class="border border-gray-300 p-2">Blood Type</th>
                             </tr>
                         </thead>
                         <tbody class="bg-white divide-y divide-gray-200">
                             <tr><td class="border p-2">Yes</td><td class="border p-2">No</td><td class="border p-2">Yes</td><td class="border p-2 font-semibold">A+</td></tr>
                             <tr class="bg-gray-50"><td class="border p-2">Yes</td><td class="border p-2">No</td><td class="border p-2">No</td><td class="border p-2 font-semibold">A-</td></tr>
                             <tr><td class="border p-2">No</td><td class="border p-2">Yes</td><td class="border p-2">Yes</td><td class="border p-2 font-semibold">B+</td></tr>
                             <tr class="bg-gray-50"><td class="border p-2">No</td><td class="border p-2">Yes</td><td class="border p-2">No</td><td class="border p-2 font-semibold">B-</td></tr>
                             <tr><td class="border p-2">Yes</td><td class="border p-2">Yes</td><td class="border p-2">Yes</td><td class="border p-2 font-semibold">AB+</td></tr>
                             <tr class="bg-gray-50"><td class="border p-2">Yes</td><td class="border p-2">Yes</td><td class="border p-2">No</td><td class="border p-2 font-semibold">AB-</td></tr>
                             <tr><td class="border p-2">No</td><td class="border p-2">No</td><td class="border p-2">Yes</td><td class="border p-2 font-semibold">O+</td></tr>
                             <tr class="bg-gray-50"><td class="border p-2">No</td><td class="border p-2">No</td><td class="border p-2">No</td><td class="border p-2 font-semibold">O-</td></tr>
                         </tbody>
                     </table>
                 </div>
             </div>

            <div id="inheritance" class="page hidden">
                <h2 class="text-2xl font-semibold mb-4 text-red-700">Blood Type Inheritance</h2>
                 <p class="mb-4">Your blood type is inherited via genes from your parents. You get one ABO gene (A, B, or O) and one Rh gene (+ or -) from each parent.</p>
                 <ul class="list-disc list-inside mb-4 space-y-1 bg-blue-50 p-4 rounded border border-blue-200">
                     <li><strong>ABO Dominance:</strong> A and B are dominant over O. A and B are co-dominant (both show). O is recessive (need two O genes for Type O).</li>
                     <li><strong>Rh Dominance:</strong> Rh+ is dominant over Rh-. Need two Rh- genes for Rh Negative.</li>
                     <li>This means children can have different blood types than their parents! (e.g., A parent (with AO genes) + B parent (with BO genes) can have an O child (OO)).</li>
                 </ul>

                 <h3 class="text-xl font-semibold mb-2">Activity: Blood Type Inheritance Predictor</h3>
                 <p class="mb-4 text-sm text-gray-600">Select the blood types for two parents to see the possible blood types their children could have (based on common gene combinations).</p>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4 p-4 border rounded-lg bg-gray-50">
                     <div>
                         <h4 class="font-semibold mb-2">Parent 1</h4>
                         <label for="p1-abo" class="mr-2 text-sm">ABO:</label>
                         <select id="p1-abo" class="border rounded p-1 mb-2 text-sm">
                             <option value="A">A</option> <option value="B">B</option> <option value="AB">AB</option> <option value="O">O</option>
                         </select>
                         <label for="p1-rh" class="ml-4 mr-2 text-sm">Rh:</label>
                         <select id="p1-rh" class="border rounded p-1 mb-2 text-sm">
                             <option value="+">+</option> <option value="-">-</option>
                         </select>
                     </div>
                     <div>
                         <h4 class="font-semibold mb-2">Parent 2</h4>
                         <label for="p2-abo" class="mr-2 text-sm">ABO:</label>
                         <select id="p2-abo" class="border rounded p-1 mb-2 text-sm">
                             <option value="A">A</option> <option value="B">B</option> <option value="AB">AB</option> <option value="O">O</option>
                         </select>
                         <label for="p2-rh" class="ml-4 mr-2 text-sm">Rh:</label>
                         <select id="p2-rh" class="border rounded p-1 mb-2 text-sm">
                             <option value="+">+</option> <option value="-">-</option>
                         </select>
                     </div>
                 </div>
                 <div class="text-center mb-4">
                     <button onclick="calculateInheritance()" class="bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-6 rounded transition duration-300">Calculate Possibilities</button>
                 </div>

                 <div id="inheritance-results" class="p-4 border rounded-lg bg-green-50 border-green-200 min-h-[100px]">
                     <h4 class="font-semibold mb-2 text-green-800">Possible Child Blood Types:</h4>
                     <p id="possible-types-text" class="text-gray-700">Select parent types and click calculate.</p>
                 </div>
             </div>

            <div id="transfusions" class="page hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-red-700">Why Transfusions Matter</h2>
                 <p class="mb-4">A blood transfusion is giving donor blood to a recipient. Correct matching is VITAL.</p>
                 <p class="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                     <strong>Why? Agglutination!</strong> If a recipient gets incompatible blood, their antibodies attack the donor's antigens, causing dangerous clumping (agglutination) that blocks blood vessels. This can be fatal.
                 </p>
                 <h3 class="text-lg font-semibold mb-2">General Compatibility Rules:</h3>
                 <ul class="list-disc list-inside mb-4 space-y-1">
                     <li><strong>Type O-</strong> is often called the Universal Donor (no A, B, or Rh antigens to attack).</li>
                     <li><strong>Type AB+</strong> is often called the Universal Recipient (no Anti-A, Anti-B, or Anti-Rh antibodies to attack donated cells).</li>
                     <li>Rh- people should ideally get Rh- blood. Rh+ people can get Rh+ or Rh-.</li>
                     <li>The recipient's antibodies must not attack the donor's antigens.</li>
                 </ul>

                 <h3 class="text-xl font-semibold mb-2">Activity: Safe Transfusion Simulation</h3>
                 <p class="mb-4 text-sm text-gray-600">Your patient needs blood! Their type is shown. Drag compatible blood bag(s) from the 'Blood Bank' to the patient. Avoid dangerous mismatches!</p>

                 <div class="flex flex-col md:flex-row gap-6 items-start">
                     <div class="w-full md:w-1/3 p-4 border rounded-lg bg-blue-100 text-center">
                         <h4 class="font-semibold mb-2">Patient</h4>
                         <div class="text-4xl font-bold text-blue-700 mb-2" id="patient-blood-type">B+</div>
                         <svg class="inline-block w-16 h-16 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                         <div id="transfusion-drop-zone" class="drop-zone mt-4 p-4 min-h-[80px] bg-blue-50 border-blue-300 rounded-lg">Drop Bag Here</div>
                         <p id="transfusion-feedback" class="mt-2 font-semibold h-8 text-sm">&nbsp;</p>
                         <button onclick="changePatientType()" class="mt-2 text-sm bg-gray-400 hover:bg-gray-600 text-white px-3 py-1 rounded">New Patient</button>
                     </div>
                     <div class="w-full md:w-2/3 p-4 border rounded-lg bg-gray-50">
                         <h4 class="font-semibold mb-3 text-center">Blood Bank (Drag a bag)</h4>
                         <div id="blood-bank" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                             </div>
                     </div>
                 </div>
             </div>

            <div id="hemostasis" class="page hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-red-700">Hemostasis - Stopping the Bleeding</h2>
                 <p class="mb-4">When you get a cut, your body acts fast to stop the bleeding. This process is called <strong>Hemostasis</strong>. It involves several steps:</p>
                 <ol class="list-decimal list-inside mb-4 space-y-2 text-sm md:text-base">
                     <li><strong>Vascular Spasm:</strong> The damaged blood vessel constricts (squeezes) immediately to reduce blood flow.</li>
                     <li><strong>Platelet Plug Formation:</strong> Tiny cell fragments called platelets stick to the damaged site and to each other, forming a temporary plug.</li>
                     <li><strong>Coagulation (Blood Clotting):</strong> This is a complex process involving clotting factors in the plasma. The end result is the formation of **fibrin**, a protein that forms a mesh over the platelet plug, trapping blood cells and making the clot stronger.</li>
                     <li><strong>Clot Retraction and Repair:</strong> The clot gradually shrinks, pulling the edges of the damaged vessel closer together. Eventually, the vessel wall repairs itself, and the clot dissolves.</li>
                 </ol>

                 <h3 class="text-xl font-semibold mb-2">Activity: Sequence the Hemostasis Steps</h3>
                 <p class="mb-4 text-sm text-gray-600">Drag the steps from the 'Steps Pool' into the correct order in the 'Sequence Area' below.</p>

                 <div class="flex flex-col md:flex-row gap-6 items-start">
                     <div id="hemostasis-steps-source" class="w-full md:w-1/3 p-4 border rounded-lg bg-gray-50 space-y-2 step-source min-h-[200px]">
                         <p class="font-semibold mb-2">Steps Pool (Drag these):</p>
                         </div>
                     <div class="w-full md:w-2/3 p-4 border rounded-lg bg-blue-50 space-y-2 step-target">
                         <p class="font-semibold mb-2 text-blue-800">Sequence Area (Drop in order):</p>
                         <div id="step-target-1" class="drop-zone p-2 border-blue-300 rounded min-h-[50px]" data-order="1"><span class="text-gray-400">1. Drop first step here</span></div>
                         <div id="step-target-2" class="drop-zone p-2 border-blue-300 rounded min-h-[50px]" data-order="2"><span class="text-gray-400">2. Drop second step here</span></div>
                         <div id="step-target-3" class="drop-zone p-2 border-blue-300 rounded min-h-[50px]" data-order="3"><span class="text-gray-400">3. Drop third step here</span></div>
                         <div id="step-target-4" class="drop-zone p-2 border-blue-300 rounded min-h-[50px]" data-order="4"><span class="text-gray-400">4. Drop fourth step here</span></div>
                         <p id="hemostasis-feedback" class="mt-2 font-semibold text-center h-6">&nbsp;</p>
                         <div class="flex justify-center gap-4 mt-2">
                             <button onclick="checkHemostasisSequence()" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded">Check Sequence</button>
                             <button onclick="resetHemostasis()" class="text-sm bg-gray-400 hover:bg-gray-600 text-white px-3 py-1 rounded">Reset</button>
                         </div>
                     </div>
                 </div>
             </div>

            <div id="quiz" class="page hidden">
                <h2 class="text-2xl font-semibold mb-4 text-red-700">Quiz Yourself!</h2>
                <p class="mb-6">Test your knowledge! Choose the best answer for each question.</p>
                <div id="quiz-questions" class="space-y-6">
                    <div class="quiz-question border p-4 rounded-lg bg-gray-50">
                        <p class="font-semibold mb-2">1. What is the main job of Red Blood Cells?</p>
                        <div class="space-y-1">
                            <label class="block"><input type="radio" name="q1" value="a"> a) Fight Infection</label>
                            <label class="block"><input type="radio" name="q1" value="b" data-correct="true"> b) Carry Oxygen</label>
                            <label class="block"><input type="radio" name="q1" value="c"> c) Clot Blood</label>
                        </div>
                        <p class="quiz-feedback mt-2 text-sm font-semibold h-4">&nbsp;</p>
                    </div>
                    <div class="quiz-question border p-4 rounded-lg bg-gray-50">
                        <p class="font-semibold mb-2">2. Which part of blood contains antibodies?</p>
                        <div class="space-y-1">
                            <label class="block"><input type="radio" name="q2" value="a"> a) Red Blood Cells</label>
                            <label class="block"><input type="radio" name="q2" value="b"> b) White Blood Cells</label>
                            <label class="block"><input type="radio" name="q2" value="c" data-correct="true"> c) Plasma</label>
                            <label class="block"><input type="radio" name="q2" value="d"> d) Platelets</label>
                        </div>
                        <p class="quiz-feedback mt-2 text-sm font-semibold h-4">&nbsp;</p>
                    </div>
                    <div class="quiz-question border p-4 rounded-lg bg-gray-50">
                        <p class="font-semibold mb-2">3. What happens when Anti-B antibodies mix with B antigens?</p>
                        <div class="space-y-1">
                            <label class="block"><input type="radio" name="q3" value="a"> a) Nothing</label>
                            <label class="block"><input type="radio" name="q3" value="b" data-correct="true"> b) Agglutination (Clumping)</label>
                            <label class="block"><input type="radio" name="q3" value="c"> c) Oxygen Release</label>
                             <label class="block"><input type="radio" name="q3" value="d"> d) Vessel Constriction</label>
                        </div>
                        <p class="quiz-feedback mt-2 text-sm font-semibold h-4">&nbsp;</p>
                    </div>
                     <div class="quiz-question border p-4 rounded-lg bg-gray-50">
                        <p class="font-semibold mb-2">4. A person with Type O- blood is often called a...?</p>
                        <div class="space-y-1">
                            <label class="block"><input type="radio" name="q4" value="a"> a) Universal Recipient</label>
                            <label class="block"><input type="radio" name="q4" value="b" data-correct="true"> b) Universal Donor</label>
                            <label class="block"><input type="radio" name="q4" value="c"> c) Common Ancestor</label>
                            <label class="block"><input type="radio" name="q4" value="d"> d) Primary Clotter</label>
                        </div>
                        <p class="quiz-feedback mt-2 text-sm font-semibold h-4">&nbsp;</p>
                    </div>
                     <div class="quiz-question border p-4 rounded-lg bg-gray-50">
                        <p class="font-semibold mb-2">5. What is the first major step in Hemostasis after injury?</p>
                        <div class="space-y-1">
                            <label class="block"><input type="radio" name="q5" value="a" data-correct="true"> a) Vascular Spasm (Vessel Constriction)</label>
                            <label class="block"><input type="radio" name="q5" value="b"> b) Platelet Plug Formation</label>
                            <label class="block"><input type="radio" name="q5" value="c"> c) Coagulation (Fibrin Clot)</label>
                            <label class="block"><input type="radio" name="q5" value="d"> d) Clot Retraction</label>
                        </div>
                        <p class="quiz-feedback mt-2 text-sm font-semibold h-4">&nbsp;</p>
                    </div>
                </div>
                <div class="text-center mt-8">
                     <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-6 rounded transition duration-300">Submit Answers</button>
                     <p id="quiz-score" class="mt-4 font-bold text-lg">&nbsp;</p>
                </div>
            </div>

        </main>

        <footer class="mt-8 pt-4 border-t border-gray-300 text-center text-sm text-gray-500">
            <p class="mb-1">This is a interactive website for anatomy, by David B, coded mostly by me, with some help from chat gtp</p>
            <p><span class="text-red-500 text-lg">❤️</span> Blood is essential for life! <span class="text-red-500 text-lg">❤️</span></p>
        </footer>
    </div>

    <script>
        // --- Global Variables & Constants ---
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-button');
        const bloodTypes = ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"];
        const hemostasisSteps = [
            { id: 'step-vasc', text: 'Vascular Spasm (Vessel Constriction)', order: 1 },
            { id: 'step-plug', text: 'Platelet Plug Formation', order: 2 },
            { id: 'step-coag', text: 'Coagulation (Fibrin Clot)', order: 3 },
            { id: 'step-repair', text: 'Clot Retraction & Repair', order: 4 }
        ];
        let draggedItem = null; // To keep track of the item being dragged

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.toggle('active-page', page.id === pageId);
                page.classList.toggle('hidden', page.id !== pageId);
            });
            navButtons.forEach(button => {
                 button.classList.toggle('active', button.dataset.page === pageId);
                 // Simple visual cue for active button
                 button.classList.toggle('bg-red-700', button.dataset.page === pageId);
                 button.classList.toggle('bg-red-500', button.dataset.page !== pageId);
            });

            // Initialize activities when their page is shown
            if (pageId === 'transfusions') {
                initializeTransfusionSim();
            } else if (pageId === 'hemostasis') {
                initializeHemostasis();
            } else if (pageId === 'types') {
                 resetTypingLab(); // Reset lab state when navigating to it
            } else if (pageId === 'components') {
                initializeDragDropComponents(); // Add listeners if not already added
            } else if (pageId === 'quiz') {
                 resetQuiz(); // Reset quiz when navigating to it
            }
        }

        // Add event listeners to nav buttons
        navButtons.forEach(button => {
            button.addEventListener('click', () => showPage(button.dataset.page));
        });

        // --- Drag and Drop Functionality ---

        // Generic Drag Start
        function handleDragStart(event) {
            draggedItem = event.target;
            // Use try...catch for dataTransfer in case of browser issues/security restrictions
            try {
                event.dataTransfer.setData('text/plain', event.target.id);
                // If it's a component source, set data attributes
                if (event.target.dataset.type) {
                    event.dataTransfer.setData('info', event.target.dataset.info);
                    event.dataTransfer.setData('type', event.target.dataset.type);
                    event.dataTransfer.setData('sourceId', event.target.id); // Keep track of original source
                }
                // If it's a blood bag
                if (event.target.dataset.bloodType) {
                    event.dataTransfer.setData('bloodType', event.target.dataset.bloodType);
                }
                // If it's a hemostasis step
                if (event.target.dataset.stepId) {
                    event.dataTransfer.setData('stepId', event.target.dataset.stepId);
                    event.dataTransfer.setData('stepText', event.target.textContent);
                    event.dataTransfer.setData('stepOrder', event.target.dataset.order);
                }
                event.dataTransfer.effectAllowed = "move"; // Indicate the type of operation allowed
            } catch (e) {
                console.error("Error setting dataTransfer data:", e);
            }


            setTimeout(() => { // Use timeout to allow original element to be painted before hiding/styling
                 // Check if draggedItem still exists before adding class
                 if(draggedItem) draggedItem.classList.add('dragging');
            }, 0);
        }

        // Generic Drag End
        function handleDragEnd(event) {
            // Check if draggedItem exists before removing class
            if (draggedItem) {
                 draggedItem.classList.remove('dragging');
            }
             draggedItem = null;
            // Remove hover effect from all drop zones
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drop-zone-hover');
            });
        }

        // Generic Drag Over
        function handleDragOver(event) {
            event.preventDefault(); // Necessary to allow dropping
            event.dataTransfer.dropEffect = "move"; // Indicate dropping is possible
            const dropZone = event.target.closest('.drop-zone');
            // Add hover effect only if it's a valid drop zone for the current drag operation
             if (isValidDropTarget(dropZone)) {
                 dropZone.classList.add('drop-zone-hover');
             }
        }

         // Generic Drag Enter
        function handleDragEnter(event) {
            event.preventDefault();
            const dropZone = event.target.closest('.drop-zone');
             if (isValidDropTarget(dropZone)) {
                 dropZone.classList.add('drop-zone-hover');
             }
        }

        // Generic Drag Leave
        function handleDragLeave(event) {
            const dropZone = event.target.closest('.drop-zone');
             if (dropZone) {
                 // Only remove hover if the mouse truly left the zone, not just moved over a child
                 if (!event.relatedTarget || !dropZone.contains(event.relatedTarget)) {
                      dropZone.classList.remove('drop-zone-hover');
                 }
            }
        }

        // Helper to check if the drop zone is valid for the dragged item
        function isValidDropTarget(dropZone) {
            if (!dropZone || !draggedItem) return false;

            // Check based on the context (which page/activity is active)
            if (document.getElementById('components').classList.contains('active-page') && dropZone.id === 'plasma-pool' && draggedItem.dataset.type) {
                return true; // Components drop
            }
            if (document.getElementById('transfusions').classList.contains('active-page') && dropZone.id === 'transfusion-drop-zone' && draggedItem.dataset.bloodType) {
                return true; // Transfusion drop
            }
             if (document.getElementById('hemostasis').classList.contains('active-page')) {
                 if (dropZone.id.startsWith('step-target-') && draggedItem.dataset.stepId) {
                     return true; // Hemostasis step drop to target
                 }
                 // Allow dropping back to source pool only if item came from a target
                 if (dropZone.id === 'hemostasis-steps-source' && draggedItem.dataset.stepId && !hemoSourcePool.contains(draggedItem)) {
                     return true; // Hemostasis step drop back to source
                 }
             }
            return false;
        }


        // Generic Drop Handler
        function handleDrop(event) {
            event.preventDefault();
            const dropZone = event.target.closest('.drop-zone');

            if (isValidDropTarget(dropZone)) { // Use the validation helper
                dropZone.classList.remove('drop-zone-hover');
                let sourceId, sourceElement;
                try {
                    sourceId = event.dataTransfer.getData('text/plain');
                    sourceElement = document.getElementById(sourceId);
                } catch (e) {
                     console.error("Error getting dataTransfer data:", e);
                     draggedItem?.classList.remove('dragging'); // Clean up visual state
                     draggedItem = null;
                     return; // Cannot proceed without data
                }


                // --- Delegate based on drop zone ID or type ---
                if (dropZone.id === 'plasma-pool') {
                    handleDropComponent(event, dropZone);
                } else if (dropZone.id === 'transfusion-drop-zone') {
                    handleDropTransfusion(event, dropZone);
                } else if (dropZone.id.startsWith('step-target-')) {
                    handleDropHemostasis(event, dropZone, sourceElement);
                } else if (dropZone.id === 'hemostasis-steps-source') {
                     // Handle drop back into the source pool (move element back)
                     if (sourceElement && draggedItem && draggedItem.dataset.stepId && !hemoSourcePool.contains(draggedItem)) {
                         sourceElement.className = 'step draggable'; // Make draggable again
                         sourceElement.draggable = true;
                         sourceElement.style.cursor = 'grab';
                         hemoSourcePool.appendChild(sourceElement); // Append (move) back
                     }
                }
            } else if(dropZone) {
                 // If it's a drop zone but not valid for this item, just remove hover
                 dropZone.classList.remove('drop-zone-hover');
            }

             // Ensure dragging style is removed after drop attempt
             if (draggedItem) {
                 draggedItem.classList.remove('dragging');
             }
             draggedItem = null; // Reset dragged item
        }

        // --- Specific Activity Logic ---

        // 1. Components: Build-A-Blood-Drop
        const plasmaPool = document.getElementById('plasma-pool');
        const infoText = document.getElementById('info-text');
        const componentSources = document.querySelectorAll('#components .draggable');

        function initializeDragDropComponents() {
            // Ensure elements exist before adding listeners
            if (!plasmaPool || componentSources.length === 0) return;
            if (plasmaPool.dataset.listenersAdded === 'true') return;


             componentSources.forEach(item => {
                 item.addEventListener('dragstart', handleDragStart);
                 item.addEventListener('dragend', handleDragEnd);
             });

             plasmaPool.addEventListener('dragover', handleDragOver);
             plasmaPool.addEventListener('dragenter', handleDragEnter);
             plasmaPool.addEventListener('dragleave', handleDragLeave);
             plasmaPool.addEventListener('drop', handleDrop);
             plasmaPool.dataset.listenersAdded = 'true';
        }

        function handleDropComponent(event, dropZone) {
             let info, type, sourceId, originalElement;
             try {
                 info = event.dataTransfer.getData('info');
                 type = event.dataTransfer.getData('type');
                 sourceId = event.dataTransfer.getData('sourceId');
                 originalElement = document.getElementById(sourceId);
             } catch (e) {
                 console.error("Error getting component drop data:", e);
                 return;
             }


             if (!info || !type || !originalElement) return;

             // Create a *copy*
             const droppedEl = originalElement.cloneNode(true);
             droppedEl.id = `dropped-${type}-${Date.now()}`;
             droppedEl.classList.remove('draggable', 'dragging');
             droppedEl.classList.add('dropped-component');
             droppedEl.style.cursor = 'pointer';

             // Position the dropped element randomly
             const poolRect = dropZone.getBoundingClientRect();
             // Use fixed size for calculation as getBoundingClientRect might be 0 for newly cloned hidden elements
             const elWidth = 40;
             const elHeight = 30;
             const maxX = Math.max(0, poolRect.width - elWidth);
             const maxY = Math.max(0, poolRect.height - elHeight);
             const randomX = Math.max(0, Math.random() * maxX);
             const randomY = Math.max(0, Math.random() * maxY);

             droppedEl.style.position = 'absolute';
             droppedEl.style.left = `${randomX}px`;
             droppedEl.style.top = `${randomY}px`;
             // Ensure dropped element has some size visually if original was complex
             droppedEl.style.width = `${elWidth}px`;
             droppedEl.style.height = `${elHeight}px`;
             droppedEl.style.lineHeight = `${elHeight}px`; // Center text vertically


             // Add click listener to show info
             droppedEl.addEventListener('click', () => {
                 // Check if infoText element exists before updating
                 if(infoText) infoText.textContent = info;
             });

             dropZone.appendChild(droppedEl);
             // Check if infoText element exists before updating
             if(infoText) infoText.textContent = `${info} (Added to pool!)`;
        }

        function resetPlasmaPool() {
            // Ensure elements exist
            if (!plasmaPool || !infoText) return;
            // Remove only dropped components, keep the title paragraph
            const dropped = plasmaPool.querySelectorAll('.dropped-component');
            dropped.forEach(el => el.remove());
            infoText.textContent = 'Click on a component in the pool to see its info here.';
        }


        // 2. Blood Types: Virtual Lab
        const typingRules = {
            // type: [reacts_with_anti_a, reacts_with_anti_b, reacts_with_anti_rh]
            'A+': [true, false, true], 'A-': [true, false, false],
            'B+': [false, true, true], 'B-': [false, true, false],
            'AB+': [true, true, true], 'AB-': [true, true, false],
            'O+': [false, false, true], 'O-': [false, false, false]
        };

        function addSerum(sampleId, serumType) {
            const well = document.getElementById(`${sampleId}-${serumType}`);
            // Ensure well exists before proceeding
            if (!well) {
                console.error(`Well element not found: ${sampleId}-${serumType}`);
                return;
            }
            const sampleContainer = well.closest('.border');
            // Ensure container exists
            if (!sampleContainer) {
                 console.error(`Sample container not found for well: ${sampleId}-${serumType}`);
                 return;
            }
            const sampleTypeContainer = sampleContainer.querySelector('.sample-type');
             // Ensure type container exists
            if (!sampleTypeContainer) {
                 console.error(`Sample type container not found for sample: ${sampleId}`);
                 return;
            }
            const actualType = sampleTypeContainer.dataset.actualType;


            if (!actualType || !typingRules[actualType]) {
                 console.error(`Invalid actual type or rules not found for type: ${actualType}`);
                 return;
            }

            let reacts = false;
            const rules = typingRules[actualType];

            if (serumType === 'anti-a' && rules[0]) reacts = true;
            if (serumType === 'anti-b' && rules[1]) reacts = true;
            if (serumType === 'anti-rh' && rules[2]) reacts = true;

            well.classList.remove('not-clumped', 'clumped'); // Clear previous state
            well.classList.add(reacts ? 'clumped' : 'not-clumped');
        }

        function checkType(sampleId) {
            const guessSelect = document.getElementById(`${sampleId}-guess`);
            const feedback = document.getElementById(`${sampleId}-feedback`);
            const sampleContainer = document.getElementById(`${sampleId}-anti-a`)?.closest('.border');
            const sampleTypeContainer = sampleContainer?.querySelector('.sample-type');

            if (!guessSelect || !feedback || !sampleTypeContainer) {
                 console.error(`Elements missing for checking type for sample: ${sampleId}`);
                 return; // Exit if elements are missing
            }

            const guess = guessSelect.value;
            const actualType = sampleTypeContainer.dataset.actualType;


            if (!guess) {
                feedback.textContent = 'Please select a type.';
                feedback.className = 'text-center mt-2 text-sm font-semibold text-yellow-600 h-4';
                return;
            }

            if (guess === actualType) {
                feedback.textContent = `Correct! It's ${actualType}.`;
                feedback.className = 'text-center mt-2 text-sm font-semibold text-green-600 h-4';
                sampleTypeContainer.textContent = actualType; // Reveal type
            } else {
                feedback.textContent = `Incorrect. Try again!`;
                feedback.className = 'text-center mt-2 text-sm font-semibold text-red-600 h-4';
            }
        }

         function resetTypingLab() {
            ['s1', 's2', 's3'].forEach(sampleId => {
                // Reset wells
                ['anti-a', 'anti-b', 'anti-rh'].forEach(serumType => {
                     const well = document.getElementById(`${sampleId}-${serumType}`);
                     if(well) {
                        well.className = 'serum-well not-clumped'; // Reset visual state
                     }
                });
                // Reset guess dropdown
                const guessSelect = document.getElementById(`${sampleId}-guess`);
                if (guessSelect) guessSelect.value = '';
                // Reset feedback
                const feedback = document.getElementById(`${sampleId}-feedback`);
                 if (feedback) {
                     feedback.textContent = '\u00A0'; // Non-breaking space to maintain height
                     feedback.className = 'text-center mt-2 text-sm font-semibold h-4';
                 }
                // Reset displayed type
                 const sampleContainer = document.getElementById(`${sampleId}-anti-a`)?.closest('.border');
                 const sampleTypeContainer = sampleContainer?.querySelector('.sample-type');
                 if(sampleTypeContainer) sampleTypeContainer.textContent = '???';
            });
         }


        // 3. Inheritance Calculator
        function getPossibleGenotypes(phenotype) {
            // Simplified: assumes most common genotypes (e.g., A is AO, B is BO)
            // This is a simplification for this basic model. Real genetics are more complex.
            switch (phenotype) {
                case 'A': return ['AO']; // Simplification
                case 'B': return ['BO']; // Simplification
                case 'AB': return ['AB'];
                case 'O': return ['OO'];
                default: return [];
            }
        }

        function getPossibleRhGenotypes(phenotype) {
             switch (phenotype) {
                case '+': return ['+-']; // Simplification (heterozygous most common)
                case '-': return ['--'];
                default: return [];
            }
        }

        function calculateInheritance() {
            const p1ABOSelect = document.getElementById('p1-abo');
            const p1RhSelect = document.getElementById('p1-rh');
            const p2ABOSelect = document.getElementById('p2-abo');
            const p2RhSelect = document.getElementById('p2-rh');
            const resultsText = document.getElementById('possible-types-text');

            // Ensure all elements exist
            if (!p1ABOSelect || !p1RhSelect || !p2ABOSelect || !p2RhSelect || !resultsText) {
                 console.error("Inheritance calculator elements missing.");
                 return;
            }

            const p1ABO = p1ABOSelect.value;
            const p1Rh = p1RhSelect.value;
            const p2ABO = p2ABOSelect.value;
            const p2Rh = p2RhSelect.value;


            const p1GenoABO = getPossibleGenotypes(p1ABO)[0]; // Take the simplified genotype
            const p2GenoABO = getPossibleGenotypes(p2ABO)[0];
            const p1GenoRh = getPossibleRhGenotypes(p1Rh)[0];
            const p2GenoRh = getPossibleRhGenotypes(p2Rh)[0];

            if (!p1GenoABO || !p2GenoABO || !p1GenoRh || !p2GenoRh) {
                resultsText.textContent = "Error calculating genotypes.";
                return;
            }

            // Calculate possible ABO offspring genotypes (simple Punnett square logic)
            const possibleABOGenotypes = new Set();
            // Iterate through alleles from parent 1 and parent 2
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 2; j++) {
                    // Combine alleles, sort alphabetically for consistency (e.g., AO, not OA)
                     possibleABOGenotypes.add([p1GenoABO[i], p2GenoABO[j]].sort().join(''));
                }
            }


            // Convert genotypes to phenotypes
            const possibleABOPhenotypes = new Set();
            possibleABOGenotypes.forEach(geno => {
                if (geno === 'AO' || geno === 'AA') possibleABOPhenotypes.add('A');
                else if (geno === 'BO' || geno === 'BB') possibleABOPhenotypes.add('B');
                else if (geno === 'AB') possibleABOPhenotypes.add('AB');
                else if (geno === 'OO') possibleABOPhenotypes.add('O');
            });

            // Calculate possible Rh offspring genotypes
            const possibleRhGenotypes = new Set();
             for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 2; j++) {
                     // Combine Rh alleles, sort (+ before -)
                     possibleRhGenotypes.add([p1GenoRh[i], p2GenoRh[j]].sort((a, b) => b.localeCompare(a)).join('')); // Ensures '+' comes first if present
                }
            }

            // Convert Rh genotypes to phenotypes
            const possibleRhPhenotypes = new Set();
            possibleRhGenotypes.forEach(geno => {
                if (geno.includes('+')) possibleRhPhenotypes.add('+');
                else possibleRhPhenotypes.add('-');
            });

            // Combine ABO and Rh possibilities
            const possibleFullTypes = new Set();
            possibleABOPhenotypes.forEach(abo => {
                possibleRhPhenotypes.forEach(rh => {
                    possibleFullTypes.add(abo + rh);
                });
            });

            if (possibleFullTypes.size > 0) {
                 // Sort the final types A, AB, B, O then +/-
                 const sortedTypes = Array.from(possibleFullTypes).sort((a, b) => {
                     const aboOrder = {'A': 1, 'B': 3, 'AB': 2, 'O': 4};
                     // Handle cases where type might just be ABO (e.g., "A") if Rh is missing
                     const aboA = a.replace(/[+-]$/, '');
                     const aboB = b.replace(/[+-]$/, '');
                     const rhA = a.endsWith('+') ? '+' : (a.endsWith('-') ? '-' : '');
                     const rhB = b.endsWith('+') ? '+' : (b.endsWith('-') ? '-' : '');


                     if (aboOrder[aboA] !== aboOrder[aboB]) {
                         return aboOrder[aboA] - aboOrder[aboB];
                     }
                     // If ABO is same, sort by Rh (+ before -)
                     return rhB.localeCompare(rhA); // '+' > '-'
                 });
                 resultsText.textContent = `Possible types: ${sortedTypes.join(', ')}`;
            } else {
                 // This case might happen if inputs are invalid, though current setup prevents it.
                 // Or if both parents are O- resulting only in O-.
                 if (p1ABO === 'O' && p1Rh === '-' && p2ABO === 'O' && p2Rh === '-') {
                     resultsText.textContent = `Possible types: O-`;
                 } else {
                      resultsText.textContent = "No possible types could be calculated (check logic).";
                 }
            }
        }


        // 4. Transfusions: Simulation
        const bloodBank = document.getElementById('blood-bank');
        const patientTypeDisplay = document.getElementById('patient-blood-type');
        const transfusionDropZone = document.getElementById('transfusion-drop-zone');
        const transfusionFeedback = document.getElementById('transfusion-feedback');

        // Compatibility rules: recipient -> [compatible donor types]
        const compatibility = {
            'A+': ['A+', 'A-', 'O+', 'O-'], 'A-': ['A-', 'O-'],
            'B+': ['B+', 'B-', 'O+', 'O-'], 'B-': ['B-', 'O-'],
            'AB+': ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'], // Universal Recipient
            'AB-': ['A-', 'B-', 'AB-', 'O-'],
            'O+': ['O+', 'O-'], 'O-': ['O-'] // O- is Universal Donor
        };

        function populateBloodBank() {
            // Ensure bloodBank element exists
            if (!bloodBank) return;
            bloodBank.innerHTML = ''; // Clear existing bags
            bloodTypes.forEach(type => {
                const bag = document.createElement('div');
                bag.id = `bag-${type}`;
                bag.className = 'blood-bag draggable';
                bag.draggable = true;
                bag.textContent = type;
                bag.dataset.bloodType = type; // Store type for checking
                bag.addEventListener('dragstart', handleDragStart);
                bag.addEventListener('dragend', handleDragEnd);
                bloodBank.appendChild(bag);
            });
        }

        function changePatientType() {
             // Ensure patientTypeDisplay exists
            if (!patientTypeDisplay) return;

            const currentType = patientTypeDisplay.textContent;
            let newType;
            // Ensure a *different* type is chosen if possible
            if (bloodTypes.length > 1) {
                 do {
                     newType = bloodTypes[Math.floor(Math.random() * bloodTypes.length)];
                 } while (newType === currentType);
            } else {
                 newType = bloodTypes[0]; // Fallback if only one type exists
            }

            patientTypeDisplay.textContent = newType;
            // Ensure feedback and drop zone elements exist
            if (transfusionFeedback) transfusionFeedback.textContent = '\u00A0'; // Clear feedback
            if (transfusionDropZone) {
                 transfusionDropZone.className = 'drop-zone mt-4 p-4 min-h-[80px] bg-blue-50 border-blue-300 rounded-lg'; // Reset drop zone style
                 transfusionDropZone.innerHTML = 'Drop Bag Here'; // Reset text
            }

        }

        function checkCompatibility(donorType, recipientType) {
            // Check if recipientType is valid before accessing compatibility rules
            if (!compatibility[recipientType]) {
                console.error("Invalid recipient type:", recipientType);
                return false;
            }
            return compatibility[recipientType].includes(donorType);
        }

        function handleDropTransfusion(event, dropZone) {
             let donorType;
             try {
                donorType = event.dataTransfer.getData('bloodType');
             } catch (e) {
                 console.error("Error getting transfusion drop data:", e);
                 return;
             }

             // Ensure elements exist
             if (!patientTypeDisplay || !transfusionFeedback || !dropZone) return;

             const recipientType = patientTypeDisplay.textContent;

             if (!donorType) return; // Dropped something else

             const isCompatible = checkCompatibility(donorType, recipientType);

             if (isCompatible) {
                 transfusionFeedback.textContent = `Safe! ${donorType} is compatible with ${recipientType}.`;
                 transfusionFeedback.className = 'mt-2 font-semibold h-8 text-sm text-green-600';
                 dropZone.className = 'drop-zone mt-4 p-4 min-h-[80px] border-blue-300 rounded-lg correct-drop'; // Green background
                 dropZone.innerHTML = `<span class="font-bold text-green-700">${donorType} Transfused!</span>`;
             } else {
                 // Find out why it's incompatible (simplified check)
                 let reason = "Causes Agglutination!";
                 // Extract ABO and Rh, handle potential errors if type format is unexpected
                 const recipientABO = recipientType.length > 1 ? recipientType.slice(0, -1) : recipientType;
                 const recipientRh = recipientType.length > 1 ? recipientType.slice(-1) : '';
                 const donorABO = donorType.length > 1 ? donorType.slice(0, -1) : donorType;
                 const donorRh = donorType.length > 1 ? donorType.slice(-1) : '';


                 // Basic incompatibility reasons
                 if ((recipientABO === 'A' || recipientABO === 'O') && donorABO.includes('B')) reason = "Recipient's Anti-B attacks Donor B antigen!";
                 else if ((recipientABO === 'B' || recipientABO === 'O') && donorABO.includes('A')) reason = "Recipient's Anti-A attacks Donor A antigen!";
                 else if (recipientRh === '-' && donorRh === '+') reason = "Rh- Recipient may react to Donor Rh+ antigen!";

                 transfusionFeedback.textContent = `DANGER! ${donorType} is incompatible with ${recipientType}. ${reason}`;
                 transfusionFeedback.className = 'mt-2 font-semibold h-8 text-sm text-red-600';
                 dropZone.className = 'drop-zone mt-4 p-4 min-h-[80px] border-blue-300 rounded-lg incorrect-drop'; // Red background
                 dropZone.innerHTML = `<span class="font-bold text-red-700">Incompatible!</span>`;
             }
        }

        function initializeTransfusionSim() {
             populateBloodBank();
             // Check if patient type is already set, if not, set one.
             if (patientTypeDisplay && (!patientTypeDisplay.textContent || patientTypeDisplay.textContent === 'B+')) { // Default might be B+ initially
                  changePatientType(); // Set initial random patient
             }


             // Add listeners only once
             if (transfusionDropZone && transfusionDropZone.dataset.listenersAdded !== 'true') {
                 transfusionDropZone.addEventListener('dragover', handleDragOver);
                 transfusionDropZone.addEventListener('dragenter', handleDragEnter);
                 transfusionDropZone.addEventListener('dragleave', handleDragLeave);
                 transfusionDropZone.addEventListener('drop', handleDrop);
                 transfusionDropZone.dataset.listenersAdded = 'true';
             }
        }


        // 5. Hemostasis: Sequencing
        const hemoSourcePool = document.getElementById('hemostasis-steps-source');
        const hemoTargets = document.querySelectorAll('#hemostasis .step-target .drop-zone');
        const hemoFeedback = document.getElementById('hemostasis-feedback');

        // Function to shuffle an array (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        function setupHemostasis() {
            // Ensure source pool exists
            if (!hemoSourcePool) return;
            hemoSourcePool.innerHTML = '<p class="font-semibold mb-2">Steps Pool (Drag these):</p>'; // Clear previous
            const shuffledSteps = [...hemostasisSteps]; // Create a copy
            shuffleArray(shuffledSteps); // Shuffle the copy

            shuffledSteps.forEach(step => {
                const stepEl = document.createElement('div');
                stepEl.id = step.id;
                stepEl.className = 'step draggable';
                stepEl.draggable = true;
                stepEl.textContent = step.text;
                stepEl.dataset.stepId = step.id;
                stepEl.dataset.order = step.order; // Store correct order
                stepEl.addEventListener('dragstart', handleDragStart);
                stepEl.addEventListener('dragend', handleDragEnd);
                hemoSourcePool.appendChild(stepEl);
            });

            // Clear target zones and reset feedback
            hemoTargets.forEach((zone, index) => {
                zone.innerHTML = `<span class="text-gray-400">${index + 1}. Drop ${['first', 'second', 'third', 'fourth'][index]} step here</span>`;
                zone.classList.remove('correct-drop', 'incorrect-drop'); // Reset visual feedback
                // Ensure the parent element exists before trying to remove class
                 zone.closest('.step-target')?.classList.remove('correct-sequence');
            });
            if (hemoFeedback) {
                 hemoFeedback.textContent = '\u00A0';
                 hemoFeedback.className = 'mt-2 font-semibold text-center h-6';
            }

        }

        function handleDropHemostasis(event, dropZone, sourceElement) {
            let stepId;
             try {
                 stepId = event.dataTransfer.getData('stepId');
                 // sourceElement is passed directly now
             } catch (e) {
                  console.error("Error getting hemostasis drop data:", e);
                  return;
             }


            if (!stepId || !sourceElement) return; // Ensure we have the step info

            // Check if drop zone already has a step (unless it's the placeholder span)
            const existingStep = dropZone.querySelector('.step');
            if (existingStep) {
                 // Move existing step back to pool
                 existingStep.className = 'step draggable'; // Make draggable again
                 existingStep.draggable = true;
                 existingStep.style.cursor = 'grab';
                 // Ensure source pool exists before appending
                 if(hemoSourcePool) hemoSourcePool.appendChild(existingStep); // Move back
            }

            // Move the dragged step element into the drop zone
            const stepEl = sourceElement; // We move the actual element
            stepEl.className = 'step'; // Remove draggable class
            stepEl.draggable = false; // Make it not draggable once dropped
            stepEl.style.cursor = 'default';
            dropZone.innerHTML = ''; // Clear placeholder text
            dropZone.appendChild(stepEl);


            if(hemoFeedback) hemoFeedback.textContent = '\u00A0'; // Clear feedback after drop
        }

        function checkHemostasisSequence() {
            let correctCount = 0;
            let allCorrect = true;
            hemoTargets.forEach(zone => {
                const expectedOrder = zone.dataset.order;
                const droppedStep = zone.querySelector('.step');
                zone.classList.remove('correct-drop', 'incorrect-drop'); // Reset colors

                if (droppedStep) {
                    const actualOrder = droppedStep.dataset.order;
                    if (actualOrder === expectedOrder) {
                        zone.classList.add('correct-drop');
                        correctCount++;
                    } else {
                        zone.classList.add('incorrect-drop');
                        allCorrect = false;
                    }
                } else {
                    allCorrect = false; // Missing a step
                }
            });

            if (hemoFeedback) {
                 if (allCorrect) {
                     hemoFeedback.textContent = "Correct Sequence!";
                     hemoFeedback.className = 'mt-2 font-semibold text-center h-6 text-green-600';
                     // Optional: Style the whole target area
                      document.querySelector('#hemostasis .step-target')?.classList.add('correct-sequence');
                 } else {
                     hemoFeedback.textContent = `Not quite right. ${correctCount} step(s) in the correct position.`;
                     hemoFeedback.className = 'mt-2 font-semibold text-center h-6 text-red-600';
                      document.querySelector('#hemostasis .step-target')?.classList.remove('correct-sequence');
                 }
            }

        }

        function resetHemostasis() {
            setupHemostasis(); // Re-shuffles and clears targets
        }

        function initializeHemostasis() {
            // Check if already initialized
            if (hemoSourcePool && hemoSourcePool.dataset.listenersAdded === 'true') return;

            setupHemostasis(); // Setup on first load or when page shown

            // Add listeners only once
            if (hemoTargets.length > 0 && hemoTargets[0].dataset.listenersAdded !== 'true') {
                hemoTargets.forEach(zone => {
                    zone.addEventListener('dragover', handleDragOver);
                    zone.addEventListener('dragenter', handleDragEnter);
                    zone.addEventListener('dragleave', handleDragLeave);
                    zone.addEventListener('drop', handleDrop);
                    zone.dataset.listenersAdded = 'true';
                });
                 // Also need listeners for the source pool if steps can be dragged back
                 if (hemoSourcePool) {
                     hemoSourcePool.addEventListener('dragover', handleDragOver);
                     hemoSourcePool.addEventListener('dragenter', handleDragEnter);
                     hemoSourcePool.addEventListener('dragleave', handleDragLeave);
                     hemoSourcePool.addEventListener('drop', handleDrop); // Use generic drop handler
                     hemoSourcePool.classList.add('drop-zone'); // Make the source pool a drop zone too
                     hemoSourcePool.dataset.listenersAdded = 'true';
                 }

            }
        }


        // 6. Quiz Logic
        const quizQuestions = document.querySelectorAll('.quiz-question');
        const quizScoreDisplay = document.getElementById('quiz-score');

        function submitQuiz() {
            let score = 0;
            quizQuestions.forEach((question, index) => {
                const feedbackEl = question.querySelector('.quiz-feedback');
                const selectedOption = question.querySelector(`input[name="q${index + 1}"]:checked`);

                // Ensure feedbackEl exists before using it
                if (!feedbackEl) return;

                feedbackEl.textContent = '\u00A0'; // Clear previous feedback
                feedbackEl.className = 'quiz-feedback mt-2 text-sm font-semibold h-4'; // Reset class

                if (selectedOption) {
                    const isCorrect = selectedOption.dataset.correct === 'true';
                    if (isCorrect) {
                        score++;
                        feedbackEl.textContent = "Correct!";
                        feedbackEl.classList.add('text-green-600');
                    } else {
                        feedbackEl.textContent = "no silly, try again"; // User requested feedback
                        feedbackEl.classList.add('text-red-600');
                        // Highlight correct answer
                        const correctInput = question.querySelector('input[data-correct="true"]');
                        if (correctInput && correctInput.parentElement) { // Check parentElement exists
                            correctInput.parentElement.classList.add('font-bold', 'text-green-700');
                        }
                    }
                    // Disable options after submitting
                    question.querySelectorAll(`input[name="q${index + 1}"]`).forEach(input => input.disabled = true);

                } else {
                    feedbackEl.textContent = "Please select an answer.";
                    feedbackEl.classList.add('text-yellow-600');
                }
            });

            if (quizScoreDisplay) {
                 quizScoreDisplay.textContent = `Your Score: ${score} out of ${quizQuestions.length}`;
                 quizScoreDisplay.classList.remove('text-green-700', 'text-blue-700'); // Clear previous color classes
                 quizScoreDisplay.classList.add(score === quizQuestions.length ? 'text-green-700' : 'text-blue-700');
            }

        }

         function resetQuiz() {
             quizQuestions.forEach((question, index) => {
                 const feedbackEl = question.querySelector('.quiz-feedback');
                 const options = question.querySelectorAll(`input[name="q${index + 1}"]`);

                 // Clear feedback
                 if (feedbackEl) {
                     feedbackEl.textContent = '\u00A0';
                     feedbackEl.className = 'quiz-feedback mt-2 text-sm font-semibold h-4';
                 }


                 // Uncheck and enable options, remove highlighting
                 options.forEach(input => {
                     input.checked = false;
                     input.disabled = false;
                     if (input.parentElement) { // Check parentElement exists
                        input.parentElement.classList.remove('font-bold', 'text-green-700');
                     }
                 });
             });
             // Clear score display
             if (quizScoreDisplay) {
                 quizScoreDisplay.textContent = '\u00A0';
                 quizScoreDisplay.className = 'mt-4 font-bold text-lg';
             }

         }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure critical elements exist before trying to initialize
            if (document.querySelectorAll('.page').length > 0 && document.querySelectorAll('.nav-button').length > 0) {
                showPage('home'); // Start on the home page
                // Pre-initialize activities that need setup regardless of first view
                initializeDragDropComponents();
                initializeTransfusionSim(); // Sets up patient & bank
                initializeHemostasis(); // Sets up steps
            } else {
                console.error("Core page elements missing, cannot initialize.");
                // Optionally display an error message to the user in the UI
            }
        });

    </script>

</body>
</html>
